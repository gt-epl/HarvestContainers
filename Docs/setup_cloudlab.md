# Cloudlab Setup Notes

## Introduction
---
All experiments (functional & performance) were carried out on resources made available by [Cloudlab](https://www.cloudlab.us).
We primarily make use of 2 resource types. Refer [cloudlab docs](http://docs.cloudlab.us/hardware.html) for more details:
1. `c6420` - 16 core Xeon Gold (Skylake)
2. `c220g5` - 20 core Xeon Silvers (Skylake)

Performance runs were carried out on `c6420` machines. We highly recommend you use the corresponding `c6420` profiles for artifact evaluation. This profile has already been setup with necessary dependencies.

If you'd like to setup from scratch, refer to `HarvestContainers/TestFramework/Bootstrap/firstboot.sh` for all dependencies.

## Requesting Resources on Cloudlab
---
We make use of the following profiles to instantiate resources (aka creating an experiment on cloudlab)
A **2 node cluster** is sufficient for all experiments.

Profiles:
1. For `c6420` - https://www.cloudlab.us/show-profile.php?uuid=70b392b8-0dc8-11ed-aacb-e4434b2381fc
2. For `c220g5` - https://www.cloudlab.us/show-profile.php?uuid=01f42c4b-c3a1-11ed-b28b-e4434b2381fc

>  **Note:** Cloudlab only allows you to create an experiment for upto 16 hours. You may request a reservation to create an experiment and then extend it for longer.


### Clone repository on all nodes

```bash
git clone https://github.com/gt-epl/HarvestContainers.git
```

### Setting up ssh access.
---
- We will rely on ssh keys and aliases to access and manage the physical nodes.
- In fact, most scripts make use of ssh aliases to address and trigger runs on different machines using the aliases specified in the template config [../TestFramework/Experiments/cloudlab/template.config](../TestFramework/Experiments/cloudlab/template.config)
- Create one key-pair (cloudlab_key / cloudlab_key.pub) exclusive for cloudlab management using `ssh-keygen` shared across nodes
- Servers are assigned ip addresses in the range 192.168.10.0/24. For a 2 node cluser, this is 192.168.10.10 and 192.168.10.11
- You can resue the provided template ssh config file. Make sure the keys and usernames are updated. oneliner to configure username: `sed "s/USER/$USER/g" template.config > ~/.ssh/config`
- Ensure both the ssh config and generated public key is available on all other nodes. The output of the public key can be appendend to `~/.ssh/authorized_keys` file.

template config file e.g.: 
```
Host clabsvr
  User USER                           <--- change this
  Hostname 192.168.10.10
  Port 22
  IdentityFile ~/.ssh/cloudlab_key    <--- generated by you using ssh-keygen
  StrictHostKeyChecking=no
```

> Optional: You may create a key-pair for github access as well, since most of the code will need to be pulled from the remote repo.

### Fix CPU frequencies for reproducible runs
- For c6420 machines:
  - Run `HarvestContainers/TestFramework/Bootstrap/powerfix.sh`
- For c220g2:
  - Turn of smt ([source](https://serverfault.com/questions/235825/))
  
    `echo off | sudo tee /sys/devices/system/cpu/smt/control` disable-hyperthreading-from-within-linux-no-access-to-bios)
  - Review and run `HarvestContainers/TestFramework/Experiment/cloudlab/bootstrap/setcpufreq.sh`
  - You may need to load acpi-cpufreq kernel module using `sudo modprobe`

### Setup Disk
1. cloudlab nodes have limited disk space. But we can mount more disk space.
2. Check if disk space is available (more than 500GB)
    ```bash
    # Commonly, for c6420 machines, disk space can be mounted on /dev/sda4. 
    lsblk -a

    # format drive
    sudo mkfs -t ext4 /dev/sda4

    # create drive. Please stick to same name for drive
    sudo mkdir /mnt/extra

    # mount drive. This will be valid till next boot
    sudo mount /dev/sda4 /mnt/extra

    # change permissions if necessary
    sudo chmod -R 775 /mnt/extra
    sudo chgrp -R nfslicer-PG0 /mnt/extra
    ```
3. helper script for c6420 machines: [../TestFramework/Bootstrap/cloudlab/c6420_disk_setup.sh](../TestFramework/Bootstrap/cloudlab/c6420_disk_setup.sh)


### Relocate Docker Files
1. By default, Docker data directory is located at /var/lib/docker. This location is problematic on Cloudlab, since / is typically provisioned with 16 GB.
2. We can relocate Docker data directory with the following steps.
3. First stop the Docker service with sudo service docker stop
4. Make a new Docker data dir with sudo mkdir /mnt/extra/docker
5. Then edit /etc/docker/daemon.json (you will likely be creating this file from scratch) and include the following:

{
    "data-root": "/mnt/extra/docker"
}

6. Add yourself to the docker group to make life easier sudo usermod -aG docker <your_username> (you'll need to logout/login for this to take effect, but afterwards you can run docker commands w/o sudo)
7. Logout and Login again for changes to take effect.
8. helper script: [../TestFramework/Bootstrap/cloudlab/relocate_docker.sh](../TestFramework/Bootstrap/cloudlab/relocate_docker.sh) 


> Ensure CPU frequencies are fixed, disks are allocated and Docker has been relocated on all cloudlab nodes before proceeding.

### Next: [Setup Kubernetes](./setup_k8s.md)